<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SP - Kamstrup Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      color: #2c5782;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      height: 75px;
      display: flex;
      align-items: center;
      justify-content: center;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #2c5782;
      color: white;
      padding: 10px;
    }
    .region-header {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #dce9f6;
      padding: 10px;
      font-size: 1.5em;
      margin-top: 30px;
    }
    .performance-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      padding: 20px;
    }
    .city-card {
      width: 200px;
      height: 180px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    canvas.donut {
      max-width: 80px;
      max-height: 80px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Kamstrup Health Report</h1>
  <script>
    const cityLookup = {};

    async function fetchChartData() {
      const container = document.body;
      const oldRegions = document.querySelectorAll('.region-header, .performance-container');
      oldRegions.forEach(el => el.remove());

      const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR7d9gYwltd4cxBZGHMg7xD-bwlJ382dxdVtMpwJ-lJ6y-bsUW4pCU4TsGBm_UGonVF64dp7sl7Xxuf/pub?gid=0&single=true&output=csv");
      const text = await response.text();
      const rows = text.trim().split('\n');
      const headers = rows[0].split(',').map(h => h.trim());
      const dataRows = rows.slice(1);

      const stateGroups = {};
      const getIndex = name => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));

      const cityIndex = getIndex('City');
      const stateIndex = getIndex('State');
      const perfIndex = getIndex('Performance');
      const totalIndex = getIndex('Total');
      const missingIndex = getIndex('Missing');

      dataRows.forEach(row => {
        const cols = row.split(',').map(c => c.trim());
        const city = cols[cityIndex];
        const state = cols[stateIndex];
        const value = parseFloat(cols[perfIndex]);
        const total = parseInt(cols[totalIndex]);
        const missing = parseInt(cols[missingIndex]);

        if (!city || !state || isNaN(value)) return;

        const cityData = {
          id: city.toLowerCase().replace(/\s+/g, '') + 'Chart',
          city, value, total, missing, state
        };

        cityLookup[city.toLowerCase()] = cityData;

        if (!stateGroups[state]) stateGroups[state] = [];
        stateGroups[state].push(cityData);
      });

      for (const state in stateGroups) {
        const header = document.createElement('div');
        header.className = 'region-header';
        const link = document.createElement('a');
        link.href = state.toLowerCase().replace(/\s+/g, '-') + '.html';
        link.textContent = state;
        link.style.textDecoration = 'none';
        link.style.color = 'inherit';
        header.appendChild(link);
        container.appendChild(header);

        const wrapper = document.createElement('div');
        wrapper.className = 'performance-container';
        container.appendChild(wrapper);

        stateGroups[state].forEach(city => {
          const div = document.createElement('div');
          div.className = 'city-card';
          div.innerHTML = `<strong>${city.city}</strong><br><span>${city.value.toFixed(2)}%</span><canvas id="${city.id}" class="donut"></canvas>`;
          div.onclick = () => showCityInfo(city.city);
          wrapper.appendChild(div);

          const ctx = div.querySelector('canvas').getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [city.value, 100 - city.value],
                backgroundColor: ['#2c5782', '#ffa500'],
                borderWidth: 0
              }]
            },
            options: {
              cutout: '50%',
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              }
            }
          });
        });
      }
    }

    function showCityInfo(cityName) {
      const city = cityLookup[cityName.toLowerCase()];
      if (!city) return;

      document.getElementById("modalCityName").textContent = city.city;
      document.getElementById("modalPerformance").textContent = city.value.toFixed(2);
      document.getElementById("modalTotal").textContent = city.total;
      document.getElementById("modalMissing").textContent = city.missing;

      document.getElementById("cityModal").style.display = "block";
      document.getElementById("modalBackdrop").style.display = "block";
    }

    function closeCityModal() {
      document.getElementById("cityModal").style.display = "none";
      document.getElementById("modalBackdrop").style.display = "none";
    }

    fetchChartData();
  </script>

<div id="cityModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background:white; padding:20px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:1000; width:320px; 
  text-align:center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:#2c5782;">
<h2 id="modalCityName" style="margin-top:0; font-size:1.6em; font-weight:bold;"></h2>
<p style="margin:8px 0;"><strong>Reading Performance:</strong><br/><span id="modalPerformance" style="font-size:1.3em;"></span>%</p>
<p style="margin:8px 0;"><strong>Total Meters:</strong><br/><span id="modalTotal"></span></p>
<p style="margin:8px 0;"><strong>Missing Reads:</strong><br/><span id="modalMissing"></span></p>
<button onclick="closeCityModal()" style="margin-top:12px; padding:10px 20px; font-weight:bold; border-radius:8px;
    border: 2px solid #2c5782; background: #e0f3ff; cursor:pointer;">Close</button>
</div>
<div id="modalBackdrop" onclick="closeCityModal()" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
  background:rgba(0,0,0,0.5); z-index:999;"></div>

<script>
  async function populateStateList() {
    const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR7d9gYwltd4cxBZGHMg7xD-bwlJ382dxdVtMpwJ-lJ6y-bsUW4pCU4TsGBm_UGonVF64dp7sl7Xxuf/pub?gid=0&single=true&output=csv");
    const text = await response.text();
    const rows = text.trim().split('\n').slice(1);
    const states = [...new Set(rows.map(row => row.split(',')[4]?.trim()).filter(Boolean))].sort();

    const container = document.getElementById("stateList");
    if (container && states.length > 0) {
      container.innerHTML = states.join(" â€¢ ");
    }
  }
  populateStateList();
</script>

</body>
</html>
