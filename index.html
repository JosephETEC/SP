<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kamstrup Health Report</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#2c5782"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR7d9gYwltd4cxBZGHMg7xD-bwlJ382dxdVtMpwJ-lJ6y-bsUW4pCU4TsGBm_UGonVF64dp7sl7Xxuf/pub?gid=0&single=true&output=csv");
    const text = await response.text();
    const rows = text.trim().split('\n').map(r => r.split(',').map(c => c.trim()));

    const headers = rows[0];
    const reportDateIndex = headers.findIndex(h => h.toLowerCase() === 'report date');
    const startDateIndex = headers.findIndex(h => h.toLowerCase() === 'start date');
    const endDateIndex = headers.findIndex(h => h.toLowerCase() === 'end date');

    if (reportDateIndex === -1 || startDateIndex === -1 || endDateIndex === -1) {
      throw new Error("Headers not found");
    }

    const row = rows[1]; // Row 2 of the sheet

    const reportDate = new Date(row[reportDateIndex]);
    const startDate = new Date(row[startDateIndex]);
    const endDate = new Date(row[endDateIndex]);

    document.getElementById('report-date').textContent = reportDate.toLocaleDateString('en-US');
    document.getElementById('start-date').textContent = startDate.toLocaleDateString('en-US');
    document.getElementById('end-date').textContent = endDate.toLocaleDateString('en-US');
  } catch (err) {
    console.error(err);
    document.getElementById('report-dates-box').innerHTML = '<strong>Unable to load report dates from sheet.</strong>';
  }
});
</script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #2c5782;
      text-align: center;
    }
    header {
      background-color: #2c5782;
      padding: 12px 20px;
      color: white;
      text-align: center;
      position: fixed;
      width: 100%;
      z-index: 1001;
      top: 0;
      height: 60px;
      box-sizing: border-box;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      line-height: 1.2;
    }
    .hamburger {
      position: fixed;
      top: 15px;
      left: 20px;
      cursor: pointer;
      z-index: 1002;
    }
    .hamburger div {
      width: 25px;
      height: 3px;
      background-color: white;
      margin: 5px 0;
      transition: all 0.3s ease;
    }
    .menu-open .hamburger div:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .menu-open .hamburger div:nth-child(2) { opacity: 0; }
    .menu-open .hamburger div:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
    .menu {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background-color: #2c5782;
      padding-top: 70px;
      transition: left 0.3s ease;
      z-index: 1000;
    }
    .menu-open .menu { left: 0; }
    .menu a {
      display: block;
      color: white;
      padding: 15px 20px;
      text-decoration: none;
      font-size: 16px;
    }
    .menu a:hover { background-color: #1a3a5e; }
    .content {
      margin-top: 60px;
      padding: 0;
      position: relative;
      z-index: 1;
    }
    .report-dates {
      font-size: 1.15em;
      margin-bottom: 30px;
    }
    .region-header {
  background-color: #dce9f6;
  padding: 12px 0;
  font-size: 2em;
  font-weight: bold;
  border-top: 2px solid #2c5782;
  margin: 40px 0 0 0;
  width: 100%;
  text-align: center;
  display: block;
}
    .performance-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      padding: 20px;
    }
    .city-card {
      width: 200px;
      height: 200px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1em;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .city-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    canvas.donut {
      max-width: 80px;
      max-height: 80px;
      margin-top: 8px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .collector-box {
      margin: 20px auto;
      max-width: 900px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .collector-box h2 {
      margin-top: 0;
    }
    .footer-bar {
      text-align: center;
      padding: 20px;
    }
    .footer-bar button {
      padding: 10px 20px;
      font-weight: bold;
      border: 2px solid #2c5782;
      background: #e0f3ff;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .footer-bar a {
      display: inline-block;
      margin-bottom: 10px;
      text-decoration: none;
      color: #2c5782;
      font-size: 0.9em;
    }
    .blinking-alert {
      font-size: 1.5em;
      margin-top: 4px;
      animation: blink 1s step-start 0s infinite;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    @media print {
      @page {
        size: landscape;
        margin: 0.3in;
      }
      body {
        zoom: 60%;
        margin: 0;
      }
      header, .footer-bar, button, .menu { display: none !important; }
      .performance-container { page-break-inside: avoid; }
      .collector-box, .region-header, .performance-container { break-inside: avoid; }
      #cityModal, #modalBackdrop { display: none !important; }
      .blinking-alert { animation: none !important; opacity: 1 !important; }
    }
  </style>
</head>
<body>
  <div class="hamburger">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <header>
    <h1>Kamstrup Health Report</h1>
  </header>
  <div class="menu">
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="louisiana.html">Louisiana</a>
    <a href="mississippi.html">Mississippi</a>
    <a href="florida.html">Florida</a>
    <a href="new-mexico.html">New Mexico</a>
    <a href="north-carolina.html">North Carolina</a>
    <a href="oregon.html">Oregon</a>
    <a href="south-carolina.html">South Carolina</a>
  </div>
  <div class="content">
    <div class="report-dates" id="report-dates-box">
      Report Date: <span id="report-date"></span><br/>
      Start Date: <span id="start-date"></span><br/>
      End Date: <span id="end-date"></span>
    </div>

    <div class="region-header">Louisiana</div>
    <div class="performance-container" id="louisiana-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-la">Loading...</div>
    </div>

    <div class="region-header">Mississippi</div>
    <div class="performance-container" id="mississippi-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-ms">Loading...</div>
    </div>

    <div class="region-header">Florida</div>
    <div class="performance-container" id="florida-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-fl">Loading...</div>
    </div>

    <div class="region-header">New Mexico</div>
    <div class="performance-container" id="new-mexico-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-nm">Loading...</div>
    </div>

    <div class="region-header">North Carolina</div>
    <div class="performance-container" id="north-carolina-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-nc">Loading...</div>
    </div>

    <div class="region-header">Oregon</div>
    <div class="performance-container" id="oregon-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-or">Loading...</div>
    </div>

    <div class="region-header">South Carolina</div>
    <div class="performance-container" id="south-carolina-container"></div>
    <div class="collector-box">
      <h2>Collector Issues</h2>
      <div id="collector-issues-content-sc">Loading...</div>
    </div>

    <div class="footer-bar">
      <button onclick="fetchChartData()">Refresh Dashboard Data</button><br/>
      <a href="https://docs.google.com/spreadsheets/d/1ty-vhb5k6FS6InlZp9CcGnwoizEdmyMz-IcPXg67tVU/edit?gid=0#gid=0" target="_blank">Edit Performance Data in Google Sheets</a>
    </div>
  </div>

  <div id="cityModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:white; padding:20px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:1000; width:320px; 
    text-align:center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:#2c5782;">
    <h2 id="modalCityName" style="margin-top:0; font-size:1.6em; font-weight:bold;"></h2>
    <p style="margin:8px 0;"><strong>Reading Performance:</strong><br/><span id="modalPerformance" style="font-size:1.3em;"></span>%</p>
    <p style="margin:8px 0;"><strong>Total Meters:</strong><br/><span id="modalTotal"></span></p>
    <p style="margin:8px 0;"><strong>Missing Reads:</strong><br/><span id="modalMissing"></span></p>
    <button onclick="closeCityModal()" style="margin-top:12px; padding:10px 20px; font-weight:bold; border-radius:8px;
      border: 2px solid #2c5782; background: #e0f3ff; cursor:pointer;">Close</button>
  </div>
  <div id="modalBackdrop" onclick="closeCityModal()" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
    background:rgba(0,0,0,0.5); z-index:999;"></div>

  <div style="text-align:center; margin-bottom: 20px;">
    <button onclick="window.print()" style="padding: 10px 20px; font-weight: bold; border: 2px solid #2c5782; background: #e0f3ff; cursor: pointer;">
      Print / Export to PDF
    </button>
  </div>
  <script>
    document.querySelector('.hamburger').addEventListener('click', () => {
      document.body.classList.toggle('menu-open');
    });

    const citiesWithIssues = new Set();

    async function fetchCollectorIssues() {
      const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR7d9gYwltd4cxBZGHMg7xD-bwlJ382dxdVtMpwJ-lJ6y-bsUW4pCU4TsGBm_UGonVF64dp7sl7Xxuf/pub?gid=0&single=true&output=csv");
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows[0];
      const data = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = row[i] ? row[i].trim() : '');
        if (obj["Collector Issue"] === "Yes") citiesWithIssues.add(obj.City);
        return obj;
      });

      const laCities = ['Hessmer', 'Lake Charles', 'Shreveport'];
      const msCities = ['Jackson', 'Okolona'];
      const flCities = ['Sunnlake'];
      const nmCities = ['Roosevelt County', 'Jal', 'Angel Fire'];
      const ncCities = ['Salemburg'];
      const orCities = ['Lakeview'];
      const scCities = ['Estill'];
      const formatEntry = (e) => `<p><strong>${e.City}:</strong> ${e["Collector Name"]}, S/N: ${e["Serial Number"]}, Last Contact: ${e["Last Contact"]}, Comments: ${e.Comments}</p>`;
      const laIssues = data.filter(e => e["Collector Issue"] === "Yes" && laCities.includes(e.City));
      const msIssues = data.filter(e => e["Collector Issue"] === "Yes" && msCities.includes(e.City));
      const flIssues = data.filter(e => e["Collector Issue"] === "Yes" && flCities.includes(e.City));
      const nmIssues = data.filter(e => e["Collector Issue"] === "Yes" && nmCities.includes(e.City));
      const ncIssues = data.filter(e => e["Collector Issue"] === "Yes" && ncCities.includes(e.City));
      const orIssues = data.filter(e => e["Collector Issue"] === "Yes" && orCities.includes(e.City));
      const scIssues = data.filter(e => e["Collector Issue"] === "Yes" && scCities.includes(e.City));

      document.getElementById('collector-issues-content-la').innerHTML = laIssues.length ? laIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
      document.getElementById('collector-issues-content-ms').innerHTML = msIssues.length ? msIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
      document.getElementById('collector-issues-content-fl').innerHTML = flIssues.length ? flIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
      document.getElementById('collector-issues-content-nm').innerHTML = nmIssues.length ? nmIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
      document.getElementById('collector-issues-content-nc').innerHTML = ncIssues.length ? ncIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
      document.getElementById('collector-issues-content-or').innerHTML = orIssues.length ? orIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
      document.getElementById('collector-issues-content-sc').innerHTML = scIssues.length ? scIssues.map(formatEntry).join('') : "<p>No collector issues reported.</p>";
    }

    async function fetchChartData() {
      document.getElementById('louisiana-container').innerHTML = '';
      document.getElementById('mississippi-container').innerHTML = '';
      document.getElementById('florida-container').innerHTML = '';
      document.getElementById('new-mexico-container').innerHTML = '';
      document.getElementById('north-carolina-container').innerHTML = '';
      document.getElementById('oregon-container').innerHTML = '';
      document.getElementById('south-carolina-container').innerHTML = '';

      const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR7d9gYwltd4cxBZGHMg7xD-bwlJ382dxdVtMpwJ-lJ6y-bsUW4pCU4TsGBm_UGonVF64dp7sl7Xxuf/pub?gid=0&single=true&output=csv");
      const text = await response.text();
      const allRows = text.trim().split('\n');
      const headers = allRows[0].split(',');
      const rows = allRows.slice(1).map(row => {
        const cols = row.split(',');
        const state = cols[headers.indexOf('State')]?.trim();
        const city = cols[headers.indexOf('City')]?.trim();
        const performance = parseFloat(cols[headers.indexOf('Performance (%)')]?.trim()) || 0;
        const total = parseInt(cols[headers.indexOf('Total Meters')]?.trim()) || 0;
        const missing = parseInt(cols[headers.indexOf('Meters with Missing Reads')]?.trim()) || 0;

        
        return { state, city, performance, total, missing };
      }).filter(row => row.state && row.city && !isNaN(row.performance));

      window.cityLookup = {};

      rows.forEach(row => {
        window.cityLookup[row.city.toLowerCase()] = {
      city: row.city,
      state: row.state,
      performance: row.performance,
      total: row.total,
      missing: row.missing
    };
        const div = document.createElement('div');
        div.className = 'city-card';
        if (citiesWithIssues.has(row.city)) {
          div.style.backgroundColor = '#ffdddd';
        }
        div.onclick = () => showCityInfo(row.city);
        div.innerHTML = `<div><strong style="font-size: 1.4em;">${row.city}</strong><br><span style="font-weight:bold; display:block; margin-top: 4px;">${row.performance.toFixed(2)}%</span><canvas id="${row.city.toLowerCase().replace(/\s+/g, '')}Chart" class="donut"></canvas>${citiesWithIssues.has(row.city) ? '<div class="blinking-alert">⚠️</div>' : ''}</div>`;

        window.cityLookup[row.city.toLowerCase()] = {
      city: row.city,
      state: row.state,
      performance: row.performance,
      total: row.total,
      missing: row.missing
    };

        const section = row.state === 'Louisiana' ? document.getElementById('louisiana-container')
          : row.state === 'Mississippi' ? document.getElementById('mississippi-container')
          : row.state === 'Florida' ? document.getElementById('florida-container')
          : row.state === 'New Mexico' ? document.getElementById('new-mexico-container')
          : row.state === 'North Carolina' ? document.getElementById('north-carolina-container')
          : row.state === 'Oregon' ? document.getElementById('oregon-container')
          : row.state === 'South Carolina' ? document.getElementById('south-carolina-container')
          : null;

        if (section) section.appendChild(div);

        const canvas = document.getElementById(`${row.city.toLowerCase().replace(/\s+/g, '')}Chart`);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [row.performance, 100 - row.performance],
                backgroundColor: ['#2c5782', '#ffa500'],
                borderWidth: 0
              }]
            },
            options: {
              cutout: '50%',
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              }
            }
          });
        }
      });
    }

    function showCityInfo(cityName) {
      const city = window.cityLookup[cityName.toLowerCase()];
      if (!city) return;
      document.getElementById("modalCityName").textContent = city.city;
      document.getElementById("modalPerformance").textContent = city.performance.toFixed(2);
      document.getElementById("modalTotal").textContent = city.total !== undefined ? city.total : 'N/A'; // Placeholder; add total meters if available
      document.getElementById("modalMissing").textContent = city.missing !== undefined ? city.missing : 'N/A'; // Placeholder; add missing reads if available
      document.getElementById("cityModal").style.display = "block";
      document.getElementById("modalBackdrop").style.display = "block";
    }

    function closeCityModal() {
      document.getElementById("cityModal").style.display = "none";
      document.getElementById("modalBackdrop").style.display = "none";
    }

    fetchCollectorIssues().then(fetchChartData);
  </script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  async function fetchCollectorIssues() {
    try {
      const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR7d9gYwltd4cxBZGHMg7xD-bwlJ382dxdVtMpwJ-lJ6y-bsUW4pCU4TsGBm_UGonVF64dp7sl7Xxuf/pub?gid=941359224&single=true&output=csv");
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headersRaw = rows[0];
      const headers = headersRaw.map(h => h.trim().toLowerCase());

      const cityIdx = headers.indexOf("city");
      const nameIdx = headers.indexOf("collector name");
      const snIdx = headers.indexOf("serial number");
      const contactIdx = headers.indexOf("last contact");
      const commentsIdx = headers.indexOf("comments");
      const issueIdx = headers.indexOf("collector issue");

      const issues = [];

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row[issueIdx]?.trim().toLowerCase() === "yes") {
          issues.push(`<p><strong>\${row[cityIdx]}:</strong> \${row[nameIdx]}, S/N: \${row[snIdx]}, Last Contact: \${row[contactIdx]}, Comments: \${row[commentsIdx]}</p>`);
        }
      }

      document.getElementById('collector-issues-content-la').innerHTML = issues.length ? issues.join('') : "<p>No collector issues reported.</p>";
    } catch (err) {
      console.error("Error fetching LA collector issues:", err);
      document.getElementById('collector-issues-content-la').innerHTML = "<p style='color:red;'>Error loading data.</p>";
    }
  }

  fetchCollectorIssues();
});
</script>

</body>
</html>
